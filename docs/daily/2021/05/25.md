# 2021年05月25日

::: tip 天气
今日杭州晴，天气温和。
:::

## 浏览器进程和线程

[[toc]]

### 进程

学术上说，进程是一个具有一定独立功能的程序在一个数据集上的一次动态执行的过程，

是操作系统进行资源分配和调度的一个独立单位，是应用程序运行的载体。

我们这里将进程比喻为工厂的车间，它代表 `CPU` 所能处理的单个任务。

任一时刻，`CPU` 总是运行一个进程，其他进程处于非运行状态。

### 线程

在早期的操作系统中并没有线程的概念，进程是能拥有资源和独立运行的最小单位，也是程序执行的最小单位。

任务调度采用的是时间片轮转的抢占式调度方式，而进程是任务调度的最小单位，每个进程有各自独立的一块内存，使得各个进程之间内存地址相互隔离。

后来，随着计算机的发展，对 `CPU` 的要求越来越高，进程之间的切换开销较大，已经无法满足越来越复杂的程序的要求了。

于是就发明了线程，线程是程序执行中一个单一的顺序控制流程，是程序执行流的最小单元。

这里把线程比喻一个车间的工人，即一个车间可以允许由多个工人协同完成一个任务。

### 两者关系

- 进程是操作系统分配资源的最小单位，线程是程序执行的最小单位。

- 一个进程由一个或多个线程组成，线程是一个进程中代码的不同执行路线；

- 进程之间相互独立，但同一进程下的各个线程之间共享程序的内存空间(包括代码段、数据集、堆等)及一些进程级的资源(如打开文件和信号)。

- 调度和切换：线程上下文切换比进程上下文切换要快得多。

### 浏览器是多进程的

浏览器是多进程的，浏览器之所以能够运行，是因为系统给它的进程分配了资源（`cpu`、内存），

简单点理解，每打开一个 `Tab` 页，就相当于创建了一个独立的浏览器进程。

1. `Browser` 进程：浏览器的主进程（负责协调、主控），只有一个。作用有：

- 负责浏览器界面显示，与用户交互。如前进，后退等
- 负责各个页面的管理，创建和销毁其他进程
- 将 `Renderer` 进程得到的内存中的 `Bitmap`，绘制到用户界面上
- 网络资源的管理，下载等

2. 第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建

3. `GPU` 进程：最多一个，用于 `3D` 绘制等

4. 浏览器渲染进程（浏览器内核）（`Renderer` 进程，内部是多线程的）：默认每个 `Tab` 页面一个进程，互不影响。主要作用为：

- 页面渲染，
- 脚本执行，
- 事件处理等

### 浏览器内核（渲染进程）

请牢记，浏览器的渲染进程是多线程的。

#### GUI 渲染线程

- 负责渲染浏览器界面，解析 `HTML`，`CSS`，构建 `DOM` 树和 `RenderObject` 树，布局和绘制等。
- 当界面需要重绘（ `Repaint` ）或由于某种操作引发回流( `reflow` )时，该线程就会执行
- 注意，`GUI` 渲染线程与 `JS` 引擎线程是互斥的，当 `JS` 引擎执行时 `GUI` 线程会被挂起（相当于被冻结了），`GUI` 更新会被保存在一个队列中等到 `JS` 引擎空闲时立即被执行。

#### JS 引擎线程

- 也称为 `JS` 内核，负责处理 `Javascript` 脚本程序。（例如 `V8` 引擎）
- `JS` 引擎线程负责解析 `Javascript` 脚本，运行代码。
- `JS` 引擎一直等待着任务队列中任务的到来，然后加以处理，一个 `Tab` 页（ `renderer` 进程）中无论什么时候都只有一个 `JS` 线程在运行 `JS` 程序
- 同样注意，`GUI `渲染线程与 `JS` 引擎线程是互斥的，所以如果 `JS` 执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。

#### 事件触发线程

- 归属于浏览器而不是 `JS` 引擎，用来控制事件循环（可以理解，`JS` 引擎自己都忙不过来，需要浏览器另开线程协助）
- 当 `JS` 引擎执行代码块如 `setTimeOut` 时（也可来自浏览器内核的其他线程,如鼠标点击、`AJAX` 异步请求等），会将对应任务添加到事件线程中
- 当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待 `JS` 引擎的处理
- 注意，由于 `JS` 的单线程关系，所以这些待处理队列中的事件都得排队等待 `JS` 引擎处理（当 `JS` 引擎空闲时才会去执行）

#### 定时触发器线程

- 传说中的 `setInterval` 与 `setTimeout` 所在线程
- 浏览器定时计数器并不是由 `JavaScript` 引擎计数的,（因为 `JavaScript` 引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确）
- 因此通过单独线程来计时并触发定时（计时完毕后，添加到事件队列中，等待 `JS` 引擎空闲后执行）
- 注意，`W3C` 在 `HTML` 标准中规定，规定要求 `setTimeout` 中低于 `4ms` 的时间间隔算为 `4ms`。

#### 异步 http 请求线程

- 在 `XMLHttpRequest` 在连接后是通过浏览器新开一个线程请求
- 将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调再放入事件队列中。再由 `JavaScript` 引擎执行。

![](https://cdn.jsdelivr.net/gh/realwds/cdn@master/blog/concept-thread.96065c97.1d0l7ue84icg.png)
